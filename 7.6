//@version=6
strategy("Project Montauk 7.6",
         overlay=true,
         shorttitle="Montauk 7.6",
         calc_on_every_tick=false,
         process_orders_on_close=true)

// 1. Inputs ──────────────────────────────────────────────────────
shortEmaLen         = input.int(15,  title="Short EMA Length",   minval=1)
medEmaLen           = input.int(30,  title="Medium EMA Length",  minval=1)
longEmaLen          = input.int(500, title="Long EMA Length",    minval=1)

// Trend-filter
enableTrend         = input.bool(true, title="Enable Trend Filter")
trendEmaLen         = input.int(70,   title="Trend EMA Length", minval=1)
slopeLookback       = input.int(10,    title="Slope Lookback Bars", minval=1)
minTrendSlope       = input.float(0.0, title="Min Trend EMA Slope", step=0.0001)

// Drop-sell
enableDrop          = input.bool(true,  title="Enable Drop-Sell Filter")
dropPct             = input.float(19.0, title="Drop Threshold (%)", step=0.1)
dropBars            = input.int(3,      title="Drop Lookback Bars", minval=1)

// Sell confirmation
enableSellConfirm   = input.bool(true,  title="Enable Sell Confirmation")
sellConfirmBars     = input.int(2,      title="Sell Confirm Bars",  minval=1)
sellBufferPct       = input.float(0.2,  title="Sell Buffer (%)",    step=0.01)

// Sell-cooldown
enableSellCooldown  = input.bool(true,  title="Enable Sell Cooldown")
sellCooldownBars    = input.int(2,      title="Sell Cooldown (bars)", minval=0)

// ATR exit
enableATRExit       = input.bool(true, title="Enable ATR Exit")
atrPeriod           = input.int(40,     title="ATR Period",        minval=1)
atrMultiplier       = input.float(3.0,  title="ATR Multiplier",    step=0.1)

// EMA Quick Exit
enableQuickExit     = input.bool(true, title="Enable EMA Quick Exit")
quickEmaLen         = input.int(15,     title="Quick EMA Length",  minval=1)
quickLookbackBars   = input.int(5,      title="Quick Exit Lookback Bars", minval=1)
quickSlopeThreshold = input.float(-1.34,title="Quick EMA Slope Threshold", step=0.01)

// 2. EMAs ────────────────────────────────────────────────────────
emaShort  = ta.ema(close, shortEmaLen)
emaMed    = ta.ema(close, medEmaLen)
emaLong   = ta.ema(close, longEmaLen)
emaTrend  = ta.ema(close, trendEmaLen)

// 3. Trend filter
trendSlope = (emaTrend - emaTrend[slopeLookback]) / slopeLookback
trendOk    = not enableTrend or (trendSlope > minTrendSlope)

// 4. Buy zone
buyZone = emaShort > emaMed

// 5. Drop-sell
dropCond = enableDrop and close < close[dropBars] * (1 - dropPct/100)

// 6. EMA cross exit
rawSell  = ta.crossunder(emaShort, emaLong)

// 7. Sell confirmation
bufferOk    = emaShort < emaLong * (1 - sellBufferPct/100)
allBelow    = ta.lowest(emaShort < emaLong ? 1 : 0, sellConfirmBars) == 1
confirmSell = not enableSellConfirm or allBelow

// 8. ATR exit
atr      = ta.atr(atrPeriod)
atrExit  = enableATRExit and close < close[1] - atr * atrMultiplier

// 9. Quick EMA exit
quickEma   = ta.ema(close, quickEmaLen)
quickSlope = (quickEma - quickEma[quickLookbackBars]) / quickLookbackBars
quickExit  = enableQuickExit and quickSlope < quickSlopeThreshold

// 10. Cooldown tracking
var int lastSellBar = na

// 11. Unified exit
exitCond = strategy.position_size > 0 and (
      (rawSell and bufferOk and confirmSell)
   or dropCond
   or atrExit
   or quickExit )

if exitCond
    strategy.close("Long")
    lastSellBar := bar_index

// 12. Entry (with optional cooldown)
canEnter = strategy.position_size == 0 and (
      not enableSellCooldown
   or na(lastSellBar)
   or (bar_index - lastSellBar) > sellCooldownBars )

if buyZone and trendOk and canEnter
    strategy.entry("Long", strategy.long)

// 13. Plots ──────────────────────────────────────────────────────
plot(emaShort, title="Short EMA",  color=color.new(color.orange, 0))
plot(emaMed,   title="Medium EMA", color=color.new(color.teal,   0))
plot(emaLong,  title="Long EMA",   color=color.new(color.purple, 0))
plot(emaTrend, title="Trend EMA",  color=color.new(#ffffff,      80))
plot(quickEma, title="Quick EMA",  color=color.new(#ffffff, 80))

// 14. Background shading
bgcolor(enableTrend ? (trendOk ? color.new(color.green,90) : color.new(color.red,90)) : na, title="Trend Filter Status")
